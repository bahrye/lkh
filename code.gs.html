const SCHOOLS_SHEET_NAME = "Schools";
const TEACHERS_SHEET_NAME = "Teachers";
const LKH_ENTRIES_SHEET_NAME = "LKH_Entries";
const KOP_SURAT_FOLDER_ID = "1uDxtZBTN5XthOsfXY3HfxvkhvWlyIbga";
const PDF_REPORTS_FOLDER_ID = "1XIbDsk9ZR6eFkMGws0PUwLUfnerMC7H4"; 

function doGet(e) {
  if (e.parameter.action === 'dashboard') {
    if (!checkUserSession()) {
      PropertiesService.getUserProperties().deleteAllProperties(); 
      return HtmlService.createTemplateFromFile('Login').evaluate()
        .setTitle('LKH Login')
        .addMetaTag('viewport', 'width=device-width, initial-scale=1')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    }
    return HtmlService.createTemplateFromFile('Index').evaluate()
      .setTitle('LKH Dashboard')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  } else {
    PropertiesService.getUserProperties().deleteAllProperties();
    return HtmlService.createTemplateFromFile('Login').evaluate()
      .setTitle('LKH Login')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}

function generateLkhId() {
  let randomNumber = '';
  for (let i = 0; i < 20; i++) {
    randomNumber += Math.floor(Math.random() * 10);
  }
  return "LKH" + randomNumber;
}

function loginUser(email, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const teacherSheet = ss.getSheetByName(TEACHERS_SHEET_NAME);
    const data = teacherSheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][3] === email && data[i][4] === password) {
        const userProperties = PropertiesService.getUserProperties();
        userProperties.setProperty('teacherId', data[i][0]); 
        userProperties.setProperty('fullName', data[i][1]);
        userProperties.setProperty('schoolId', data[i][5]);
        return { status: 'success', teacherId: data[i][0] };
      }
    }
    return { status: 'error', message: 'Email atau Password salah.' };
  } catch (err) {
    Logger.log("Error in loginUser: " + err.message + " Stack: " + err.stack);
    return { status: 'error', message: 'Error server saat login: ' + err.message };
  }
}

function logoutUser() {
  PropertiesService.getUserProperties().deleteAllProperties();
  return { status: 'success' };
}

function checkUserSession() {
  const userProperties = PropertiesService.getUserProperties();
  return userProperties.getProperty('teacherId') !== null;
}

function getLoggedInUserDetails() {
  if (!checkUserSession()) return null;
  const userProperties = PropertiesService.getUserProperties();
  const teacherId = userProperties.getProperty('teacherId');
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const teacherSheet = ss.getSheetByName(TEACHERS_SHEET_NAME);
    const data = teacherSheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === teacherId) { // TeacherID di kolom A (indeks 0)
        return {
          teacherId: data[i][0],
          fullName: data[i][1],
          nip: data[i][2],
          email: data[i][3],
          schoolId: data[i][5],
          mainDuty: data[i][6] || '',      // Tugas Pokok di kolom G (indeks 6)
          mataPelajaran: data[i][7] || '', // Mata Pelajaran di kolom H (indeks 7)
          kelas: data[i][8] || ''         // Kelas di kolom I (indeks 8)
        };
      }
    }
  } catch (err) {
    Logger.log("Error in getLoggedInUserDetails: " + err.message + " Stack: " + err.stack);
  }
  return null;
}

function getSchoolDetailsForCurrentUser() {
  const userDetails = getLoggedInUserDetails();
  if (!userDetails || !userDetails.schoolId) return null;
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const schoolSheet = ss.getSheetByName(SCHOOLS_SHEET_NAME);
    const data = schoolSheet.getDataRange().getValues();
    const header = data[0];

    const schoolIdColIdx = 0;
    const schoolNameColIdx = header.indexOf("SchoolName") > -1 ? header.indexOf("SchoolName") : 1;
    const foundationNameColIdx = header.indexOf("FoundationName") > -1 ? header.indexOf("FoundationName") : 2;
    const schoolAddressColIdx = header.indexOf("SchoolAddress") > -1 ? header.indexOf("SchoolAddress") : 3;
    const headmasterNameColIdx = header.indexOf("HeadmasterName") > -1 ? header.indexOf("HeadmasterName") : 4;
    const headmasterNIPColIdx = header.indexOf("HeadmasterNIP") > -1 ? header.indexOf("HeadmasterNIP") : 5;
    const kopSuratSourceValueColIdx = header.indexOf("KopSuratSourceValue") > -1 ? header.indexOf("KopSuratSourceValue") : 6;
    const kopSuratSourceTypeColIdx = header.indexOf("KopSuratSourceType") > -1 ? header.indexOf("KopSuratSourceType") : 7;
    const kopSuratWidthColIdx = header.indexOf("KopSuratWidth") > -1 ? header.indexOf("KopSuratWidth") : 8;
    const kopSuratHeightColIdx = header.indexOf("KopSuratHeight") > -1 ? header.indexOf("KopSuratHeight") : 9;
    const kopSuratAlignmentColIdx = header.indexOf("KopSuratAlignment") > -1 ? header.indexOf("KopSuratAlignment") : 10;
    const typeKepalaMadrasahColIdx = header.indexOf("type_KepalaMadrasah") > -1 ? header.indexOf("type_KepalaMadrasah") : 11;

    for (let i = 1; i < data.length; i++) {
      if (data[i][schoolIdColIdx] === userDetails.schoolId) {
        const sourceValue = data[i][kopSuratSourceValueColIdx] || null;
        const sourceType = data[i][kopSuratSourceTypeColIdx] || (sourceValue ? 'drive' : null); 
        
        return {
          schoolId: data[i][schoolIdColIdx],
          schoolName: data[i][schoolNameColIdx],
          foundationName: data[i][foundationNameColIdx],
          schoolAddress: data[i][schoolAddressColIdx],
          headmasterName: data[i][headmasterNameColIdx],
          headmasterNIP: data[i][headmasterNIPColIdx],
          typeKepalaMadrasah: data[i][typeKepalaMadrasahColIdx] || 'Kepala Madrasah',
          _rawKopSuratSourceValue: sourceValue,
          _rawKopSuratSourceType: sourceType,
          _rawKopSuratWidth: data[i][kopSuratWidthColIdx] || '100%',
          _rawKopSuratHeight: data[i][kopSuratHeightColIdx] || 'auto',
          _rawKopSuratAlignment: data[i][kopSuratAlignmentColIdx] || 'center'
        };
      }
    }
  } catch (err) {
    Logger.log("Error in getSchoolDetailsForCurrentUser: " + err.message + " Stack: " + err.stack);
  }
  return null;
}

function getInitialDashboardData() {
  const user = getLoggedInUserDetails();
  const schoolDetails = getSchoolDetailsForCurrentUser(); 
  
  let currentKopSuratViewData = {
    sourceValue: null, url: null, width: '100%', height: 'auto', alignment: 'center', sourceType: null
  };

  if (schoolDetails) {
    const sourceValue = schoolDetails._rawKopSuratSourceValue;
    const sourceType = schoolDetails._rawKopSuratSourceType;
    currentKopSuratViewData.sourceValue = sourceValue;
    currentKopSuratViewData.sourceType = sourceType;
    currentKopSuratViewData.width = schoolDetails._rawKopSuratWidth;
    currentKopSuratViewData.height = schoolDetails._rawKopSuratHeight;
    currentKopSuratViewData.alignment = schoolDetails._rawKopSuratAlignment;
    if (sourceValue) {
      if (sourceType === 'url') currentKopSuratViewData.url = sourceValue;
      else if (sourceType === 'drive') {
        try { currentKopSuratViewData.url = `https://drive.google.com/uc?export=view&id=${sourceValue}`; } 
        catch (e) { Logger.log("Gagal verify ID kop surat: " + sourceValue + "; Error: " + e.message); currentKopSuratViewData.url = null; }
      }
    }
  }
  
  let finalSchoolDetails = {...schoolDetails};
  delete finalSchoolDetails._rawKopSuratSourceValue;
  delete finalSchoolDetails._rawKopSuratSourceType;
  delete finalSchoolDetails._rawKopSuratWidth;
  delete finalSchoolDetails._rawKopSuratHeight;
  delete finalSchoolDetails._rawKopSuratAlignment;

  return { user: user, school: finalSchoolDetails, currentKopSurat: currentKopSuratViewData };
}

function getNextOrderInDay(sheet, teacherId, dateOfActivity) {
  const data = sheet.getDataRange().getValues();
  let maxOrder = 0;
  const targetDateStr = Utilities.formatDate(new Date(dateOfActivity), Session.getScriptTimeZone(), "yyyy-MM-dd");
  for (let i = 1; i < data.length; i++) {
    if (!data[i][1] || !data[i][2]) continue;
    if (data[i][1] === teacherId) {
      const entryDate = new Date(data[i][2]);
      if (isNaN(entryDate.getTime())) continue;
      const entryDateStr = Utilities.formatDate(entryDate, Session.getScriptTimeZone(), "yyyy-MM-dd");
      if (entryDateStr === targetDateStr) {
        const currentOrder = parseInt(data[i][8]);
        if (!isNaN(currentOrder) && currentOrder > maxOrder) {
          maxOrder = currentOrder;
        }
      }
    }
  }
  return maxOrder + 1;
}

function checkDuplicateLkhEntry(teacherId, dateOfActivity, description, output, volume) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const inputDateStr = Utilities.formatDate(new Date(dateOfActivity), Session.getScriptTimeZone(), "yyyy-MM-dd");
    for (let i = 1; i < data.length; i++) {
      if (!data[i][1] || !data[i][2]) continue;
      if (data[i][1] === teacherId) {
        const sheetDate = new Date(data[i][2]);
        if (isNaN(sheetDate.getTime())) continue;
        const sheetDateStr = Utilities.formatDate(sheetDate, Session.getScriptTimeZone(), "yyyy-MM-dd");
        if (sheetDateStr === inputDateStr &&
            String(data[i][4] || '') === String(description || '') &&
            String(data[i][5] || '') === String(output || '') &&
            String(data[i][6] || '') === String(volume || '')) {
          Logger.log("Duplicate found: Row " + (i+1) + " matches input for date " + inputDateStr);
          return true;
        }
      }
    }
  } catch (e) {
    Logger.log("Error in checkDuplicateLkhEntry: " + e.toString() + " Stack: " + e.stack);
    return false;
  }
  return false;
}

function addLkhEntry(entryData) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  const dateString = entryData.dateOfActivity;
  const parts = dateString.split('-');
  const year = parseInt(parts[0], 10);
  const month = parseInt(parts[1], 10) - 1; 
  const day = parseInt(parts[2], 10);
  const dateOfActivity = new Date(year, month, day);
  const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
  const dayName = days[dateOfActivity.getDay()];

  if (checkDuplicateLkhEntry(userDetails.teacherId, dateOfActivity, entryData.description, entryData.output, entryData.volume)) {
    return { status: 'warning', message: 'Kegiatan yang sama persis sudah ada pada tanggal ini dan tidak ditambahkan lagi.' };
  }
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const lkhSheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const newEntryId = generateLkhId();
    const orderInDay = getNextOrderInDay(lkhSheet, userDetails.teacherId, dateOfActivity);
    lkhSheet.appendRow([
      newEntryId, userDetails.teacherId, dateOfActivity, dayName,
      entryData.description, entryData.output, entryData.volume, new Date(), orderInDay
    ]);
    return { status: 'success', message: 'Data LKH berhasil ditambahkan.' };
  } catch (err) {
    Logger.log("Error in addLkhEntry: " + err.message + " Stack: " + err.stack);
    return { status: 'error', message: 'Gagal menyimpan data: ' + err.message };
  }
}

function addRecurringLkhEntries(recurringData) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const lkhSheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const [yearStr, monthStr] = recurringData.monthYear.split('-');
    const year = parseInt(yearStr);
    const month = parseInt(monthStr) - 1;
    const targetDayOfWeek = recurringData.dayOfWeek;
    const daysInIndonesian = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    let entriesAddedCount = 0;
    let entriesSkippedCount = 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let day = 1; day <= daysInMonth; day++) {
      const currentDate = new Date(year, month, day);
      if (currentDate.getDay() === targetDayOfWeek) {
        if (checkDuplicateLkhEntry(userDetails.teacherId, currentDate, recurringData.description, recurringData.output, recurringData.volume)) {
          entriesSkippedCount++;
          continue;
        }
        const newEntryId = generateLkhId();
        const dayName = daysInIndonesian[currentDate.getDay()];
        const orderInDay = getNextOrderInDay(lkhSheet, userDetails.teacherId, currentDate);
        lkhSheet.appendRow([
          newEntryId, userDetails.teacherId, currentDate, dayName,
          recurringData.description, recurringData.output, recurringData.volume, new Date(), orderInDay
        ]);
        entriesAddedCount++;
      }
    }
    let message = "";
    if (entriesAddedCount > 0) message += entriesAddedCount + ' kegiatan berulang berhasil ditambahkan. ';
    if (entriesSkippedCount > 0) message += entriesSkippedCount + ' kegiatan dilewati karena sudah ada entri yang sama persis.';
    if (message === "") message = 'Tidak ada hari ' + daysInIndonesian[targetDayOfWeek] + ' yang ditemukan atau semua kegiatan yang cocok sudah ada.';
    return { status: (entriesAddedCount > 0 ? 'success' : 'info'), message: message.trim() };
  } catch (err) {
    Logger.log("Error in addRecurringLkhEntries: " + err.message + " Stack: " + err.stack);
    return { status: 'error', message: 'Gagal menyimpan kegiatan berulang: ' + err.message };
  }
}

function getLkhEntriesForMonth(monthYear) {
  if (!checkUserSession()) return [];
  const userDetails = getLoggedInUserDetails();
  if (!userDetails) { 
    Logger.log("getLkhEntriesForMonth: userDetails is null, exiting.");
    return [];
  }
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const lkhSheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = lkhSheet.getDataRange().getValues();
    const entries = [];
    const [yearFilter, monthFilter] = monthYear.split('-').map(Number);
    for (let i = 1; i < data.length; i++) { 
      if (data[i].length < 9) continue; 
      const sheetTeacherId = String(data[i][1] || '').trim();
      const currentUserTeacherId = String(userDetails.teacherId).trim();
      if (sheetTeacherId === currentUserTeacherId) {
        const activityDateRaw = data[i][2]; 
        if (!activityDateRaw) continue; 
        const activityDate = new Date(activityDateRaw);
        if (isNaN(activityDate.getTime())) continue; 
        const activityYear = activityDate.getFullYear();
        const activityMonth = activityDate.getMonth() + 1;
        if (activityYear === yearFilter && activityMonth === monthFilter) {
          const description = (data[i][4] === null || data[i][4] === undefined) ? "" : String(data[i][4]);
          const output = (data[i][5] === null || data[i][5] === undefined) ? "" : String(data[i][5]);
          const volume = (data[i][6] === null || data[i][6] === undefined) ? "" : String(data[i][6]);
          const orderInDayVal = (data[i][8] === null || data[i][8] === undefined || data[i][8] === "") ? 0 : parseInt(data[i][8]);
          entries.push({
            entryId: String(data[i][0] || ''), 
            teacherId: sheetTeacherId,
            dateOfActivity: Utilities.formatDate(activityDate, Session.getScriptTimeZone(), "yyyy-MM-dd"),
            dayOfActivity: String(data[i][3] || ''), 
            description: description,
            output: output, 
            volume: volume,
            submissionTimestamp: data[i][7] ? new Date(data[i][7]).toISOString() : '',
            orderInDay: orderInDayVal
          });
        }
      }
    }
    entries.sort((a, b) => {
        const dateComparison = new Date(a.dateOfActivity) - new Date(b.dateOfActivity);
        if (dateComparison !== 0) return dateComparison;
        return a.orderInDay - b.orderInDay;
    });
    return entries;
  } catch (err) {
    Logger.log("Error in getLkhEntriesForMonth: " + err.message + " Stack: " + err.stack);
    return [];
  }
}

/**
 * =================================================================================
 * FUNGSI BARU: Untuk memproses data mentah menjadi data yang siap dirender dengan rowspan
 * =================================================================================
 */
function _prepareReportData(entries) {
  if (!entries || entries.length === 0) return [];
  
  let groupedByDate = {};
  entries.forEach(entry => {
    if (!groupedByDate[entry.dateOfActivity]) {
      groupedByDate[entry.dateOfActivity] = [];
    }
    groupedByDate[entry.dateOfActivity].push(entry);
  });

  let processedEntries = [];
  Object.keys(groupedByDate).sort().forEach(dateKey => {
    const dateEntries = groupedByDate[dateKey];
    const dateGroupSize = dateEntries.length;

    for (let i = 0; i < dateGroupSize; ) {
      let entry = {...dateEntries[i]};

      // Inisialisasi: Rowspan untuk kolom yang selalu digabung per hari
      entry.rowspan_nomor = (i === 0) ? dateGroupSize : 0;
      entry.rowspan_tanggal = (i === 0) ? dateGroupSize : 0;
      entry.rowspan_paraf = (i === 0) ? dateGroupSize : 0;

      // Logika untuk Output (gabung jika berurutan & sama)
      let output_rowspan = 1;
      for (let j = i + 1; j < dateGroupSize; j++) {
        if (dateEntries[j].output === entry.output) {
          output_rowspan++;
        } else {
          break; // Berhenti jika tidak sama
        }
      }
      entry.rowspan_output = output_rowspan;

      // Logika untuk Volume (gabung jika berurutan & sama)
      let volume_rowspan = 1;
      for (let j = i + 1; j < dateGroupSize; j++) {
        if (dateEntries[j].volume === entry.volume) {
          volume_rowspan++;
        } else {
          break; // Berhenti jika tidak sama
        }
      }
      entry.rowspan_volume = volume_rowspan;
      
      // Tentukan jumlah baris maksimum yang digabung untuk iterasi ini
      // Ini penting agar kita bisa melompati entri yang sudah 'tergabung'
      let max_consecutive_span = Math.min(output_rowspan, volume_rowspan);
      // Namun, kita proses satu per satu. Entri saat ini (i) selalu ditambahkan.
      processedEntries.push(entry);
      
      // Tambahkan entri berikutnya yang tergabung secara implisit (rowspan=0)
      let group_span_for_iteration = 1; // Default
      // Kita cari span terkecil dari output/volume untuk menentukan berapa baris yang dilewati
      let row_span_to_check = Math.max(output_rowspan, volume_rowspan);
      
      let advanceBy = 1;
      // Loop untuk menandai entri berikutnya sebagai 'sudah digabung'
      for (let k = 1; k < row_span_to_check; k++) {
        if ((i + k) < dateGroupSize) {
           let nextEntry = {...dateEntries[i + k]};
           nextEntry.rowspan_nomor = 0;
           nextEntry.rowspan_tanggal = 0;
           nextEntry.rowspan_paraf = 0;
           // Jika entri ini masih bagian dari grup 'output', set rowspannya ke 0
           nextEntry.rowspan_output = (k < output_rowspan) ? 0 : 1; 
           // Jika entri ini masih bagian dari grup 'volume', set rowspannya ke 0
           nextEntry.rowspan_volume = (k < volume_rowspan) ? 0 : 1;

           processedEntries.push(nextEntry);
           advanceBy++;
        }
      }

      i += advanceBy; // Maju ke entri berikutnya yang belum diproses
    }
  });

  return processedEntries;
}


function generateReportHtmlForMonth(monthYear) {
  const user = getLoggedInUserDetails();
  const school = getSchoolDetailsForCurrentUser();
  let entries = getLkhEntriesForMonth(monthYear);

  if (!user || !school) {
    return "<p>Error: Tidak dapat memuat data pengguna atau sekolah.</p>";
  }
  
  // ==================== PERUBAHAN UTAMA DI SINI ====================
  // Menggunakan fungsi _prepareReportData untuk memproses data
  const processedEntries = _prepareReportData(entries);
  // =================================================================

  let reportPeriod = "Data tidak tersedia";
  let workingDays = 0;
  
  if (entries && entries.length > 0) {
    let uniqueDates = new Set(entries.map(e => e.dateOfActivity));
    workingDays = uniqueDates.size;
    const sortedDates = Array.from(uniqueDates).sort();
    const firstDate = new Date(sortedDates[0]);
    const lastDate = new Date(sortedDates[sortedDates.length - 1]);
    reportPeriod = `${firstDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} - ${lastDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} (${workingDays} Hari Kerja)`;
  } else if (monthYear) {
    const [yearStrVal, monthNumVal] = monthYear.split('-');
    reportPeriod = `Bulan ${new Date(parseInt(yearStrVal), parseInt(monthNumVal)-1, 1).toLocaleDateString('id-ID', { month: 'long' })} ${yearStrVal} (0 Hari Kerja)`;
  }

  let html = `<html><head><title>LKH Report</title><?!= HtmlService.createHtmlOutputFromFile('Stylesheet').getContent(); ?></head><body>`;
  html += `<div class="report-container">`;

  let imageUrlForReport = '';
  if (school && school._rawKopSuratSourceValue) {
      const sourceVal = school._rawKopSuratSourceValue;
      const sourceTyp = school._rawKopSuratSourceType || (sourceVal ? 'drive' : null) ; 
      if (sourceTyp === 'url') imageUrlForReport = sourceVal;
      else if (sourceTyp === 'drive') imageUrlForReport = `https://drive.google.com/uc?export=view&id=${sourceVal}`;
  }

  if (imageUrlForReport) {
      const imageWidth = school._rawKopSuratWidth || '100%';
      const imageHeight = school._rawKopSuratHeight || 'auto';
      const imageAlignment = school._rawKopSuratAlignment || 'center';
      let textAlignStyle = (imageAlignment === 'left') ? 'text-align: left;' : (imageAlignment === 'right') ? 'text-align: right;' : 'text-align: center;';
      html += `<div class="header" style="${textAlignStyle}"><img src="${imageUrlForReport}" alt="Kop Surat" style="width: ${imageWidth}; height: ${imageHeight}; max-width:100%;"></div>`;
  } else if (school) {
      html += `<div class="header"><h2>${school.foundationName || ''}</h2><h3>${school.schoolName || ''}</h3><p>${school.schoolAddress || ''}</p></div>`;
  } else {
      html += `<div class="header"><p>Informasi sekolah tidak tersedia.</p></div>`;
  }
  html += `<hr/>`;
  html += `<h4>LAPORAN KINERJA HARIAN (LKH)<br/>GURU DAN TENAGA KEPENDIDIKAN ${school.schoolName || ''}<br/>PEMBELAJARAN TATAP MUKA</h4>`;
  
  html += `<table class="info-table">
             <tr><td>NAMA</td><td>: ${user.fullName || ''}</td></tr>
             <tr><td>NIP</td><td>: ${user.nip || '-'}</td></tr>
             <tr><td>TUGAS POKOK</td><td>: ${user.mainDuty || ''}</td></tr>
             <tr><td>MATA PELAJARAN</td><td>: ${user.mataPelajaran || '-'}</td></tr>
             <tr><td>KELAS</td><td>: ${user.kelas || '-'}</td></tr> 
             <tr><td>HARI/TANGGAL</td><td>: ${reportPeriod}</td></tr>
           </table><br/>`;

  html += `<table class="data-table"><thead><tr><th>NO</th><th>HARI/<br/>TANGGAL</th><th>URAIAN KEGIATAN</th><th>HASIL/OUTPUT</th><th>VOL</th><th>PARAF</th><th>AKSI</th></tr></thead><tbody>`;

  if (processedEntries.length === 0) {
    html += `<tr><td colspan="7" style="text-align:center;">Tidak ada data kegiatan untuk periode ini.</td></tr>`;
  } else {
    let currentEntryNumber = 0; 
    processedEntries.forEach((pEntry) => {
      html += `<tr>`; 
      if (pEntry.rowspan_nomor > 0) { 
        currentEntryNumber++;
        html += `<td rowspan="${pEntry.rowspan_nomor}" style="text-align: center; vertical-align: middle;">${currentEntryNumber}</td>`; 
      }
      if (pEntry.rowspan_tanggal > 0) {
        html += `<td rowspan="${pEntry.rowspan_tanggal}" style="text-align: center; vertical-align: middle;">${pEntry.dayOfActivity},<br/>${new Date(pEntry.dateOfActivity).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</td>`; 
      }
      
      html += `<td style="text-align: left; vertical-align: middle;">${pEntry.description ? String(pEntry.description).replace(/\n/g, '<br>') : ''}</td>`;
      
      if (pEntry.rowspan_output > 0) {
        html += `<td rowspan="${pEntry.rowspan_output}" style="text-align: left; vertical-align: middle;">${pEntry.output ? String(pEntry.output).replace(/\n/g, '<br>') : ''}</td>`;
      }
      if (pEntry.rowspan_volume > 0) {
        html += `<td rowspan="${pEntry.rowspan_volume}" style="text-align: center; vertical-align: middle;">${pEntry.volume ? String(pEntry.volume).replace(/\n/g, '<br>') : ''}</td>`;
      }
      if (pEntry.rowspan_paraf > 0) {
        html += `<td rowspan="${pEntry.rowspan_paraf}"></td>`; 
      }
      
      // Kolom Aksi selalu ditampilkan untuk setiap baris
      html += `<td style="text-align: left; vertical-align: middle;">`;
      html += `<button class="action-btn delete-btn" onclick="confirmDeleteEntry('${pEntry.entryId}')">Hapus</button>`;
      // Logika untuk tombol pindah (move) tidak berubah
      const dayGroup = entries.filter(e => e.dateOfActivity === pEntry.dateOfActivity);
      const isFirstInDayGroup = dayGroup[0].entryId === pEntry.entryId;
      const isLastInDayGroup = dayGroup[dayGroup.length - 1].entryId === pEntry.entryId;
      if (dayGroup.length > 1) { 
          if (!isFirstInDayGroup) html += `<button class="action-btn move-btn" title="Naikkan" onclick="handleMoveEntryOrder('${pEntry.entryId}', 'up')">&uarr;</button>`;
          if (!isLastInDayGroup) html += `${!isFirstInDayGroup ? ' ' : ''}<button class="action-btn move-btn" title="Turunkan" onclick="handleMoveEntryOrder('${pEntry.entryId}', 'down')">&darr;</button>`;
      }
      html += `</td></tr>`; 
    });
  }
  html += `</tbody></table><br/>`;

  let dateForFooterSignature = (entries.length > 0) ? 
    new Date(entries[entries.length - 1].dateOfActivity).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) :
    (monthYear ? new Date(parseInt(monthYear.split('-')[0]), parseInt(monthYear.split('-')[1])-1, new Date(parseInt(monthYear.split('-')[0]), parseInt(monthYear.split('-')[1]), 0).getDate()).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) :
    new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }));
    
  let locationName = 'Butung'; 
  if (school.schoolAddress) {
      const addressParts = school.schoolAddress.split(/[ ,]+/); 
      if (addressParts.length > 0) {
        const lingkunganIndex = addressParts.findIndex(part => part.toLowerCase() === 'lingkungan');
        if (lingkunganIndex !== -1 && lingkunganIndex + 1 < addressParts.length) {
            locationName = addressParts[lingkunganIndex + 1];
        } else {
            locationName = addressParts[0];
        }
        locationName = locationName.charAt(0).toUpperCase() + locationName.slice(1).toLowerCase(); 
      }
  }

  const headmasterTitle = school.typeKepalaMadrasah || 'Kepala Madrasah'; 
  const normalizedUserName = (user.fullName || '').trim().toLowerCase();
  const normalizedHeadmasterName = (school.headmasterName || '').trim().toLowerCase();

  html += `<div class="footer-signatures">`;

  if (normalizedUserName && normalizedHeadmasterName && normalizedUserName === normalizedHeadmasterName) {
    html += `<div class="signature-block">
               </div>
             <div class="signature-block">
               <p>${locationName}, ${dateForFooterSignature}</p>
               <p>${headmasterTitle}</p> 
               <br/><br/><br/>
               <p><strong><u>${school.headmasterName || ''}</u></strong></p>
               <p>NIP. ${school.headmasterNIP || '-'}</p>
             </div>`;
  } else {
    let teacherNameForSignature = user.fullName || 'NAMA GURU';
    const commaIndexTeacher = teacherNameForSignature.indexOf(',');
    if (commaIndexTeacher !== -1) {
        let namePart = teacherNameForSignature.substring(0, commaIndexTeacher);
        let titlePart = teacherNameForSignature.substring(commaIndexTeacher);
        teacherNameForSignature = namePart.toUpperCase() + titlePart;
    } else {
        teacherNameForSignature = teacherNameForSignature.toUpperCase();
    }

    html += `
        <div class="signature-block">
          <p>Mengetahui,<br/>${headmasterTitle}</p>
          <br/><br/><br/>
          <p><strong><u>${school.headmasterName || ''}</u></strong></p>
          <p>NIP. ${school.headmasterNIP || '-'}</p>
        </div>
        <div class="signature-block">
          <p>${locationName}, ${dateForFooterSignature}<br/>Guru Pengajar</p>
          <br/><br/><br/>
          <p><strong><u>${teacherNameForSignature}</u></strong></p>
          <p>NIP. ${user.nip || '-'}</p>
        </div>`;
  }
  html += `</div>`;
  html += `</div></body></html>`;
  return html;
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// ... (Fungsi-fungsi lain seperti deleteLkhEntry, updateLkhEntry, dll. tetap sama) ...
function deleteLkhEntry(entryId) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid. Silakan login ulang.' };
  const userDetails = getLoggedInUserDetails();
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    let rowToDelete = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === entryId) {
        if (data[i][1] !== userDetails.teacherId) return { status: 'error', message: 'Tidak diizinkan menghapus entri ini.' };
        rowToDelete = i + 1;
        break;
      }
    }
    if (rowToDelete > -1) {
      sheet.deleteRow(rowToDelete);
      return { status: 'success', message: 'Kegiatan berhasil dihapus.' };
    }
    return { status: 'error', message: 'Kegiatan tidak ditemukan.' };
  } catch (e) {
    Logger.log('Error deleting entry: ' + e.toString() + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal menghapus kegiatan: ' + e.message };
  }
}

function getLkhEntryDetails(entryId) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === entryId) {
        if (data[i][1] !== userDetails.teacherId) return { status: 'error', message: 'Tidak diizinkan mengakses entri ini.' };
        return { status: 'success', data: {
            entryId: data[i][0], dateOfActivity: new Date(data[i][2]),
            description: String(data[i][4] || ''), output: String(data[i][5] || ''),
            volume: String(data[i][6] || '')
          }};
      }
    }
    return { status: 'error', message: 'Entri tidak ditemukan.' };
  } catch (e) {
    Logger.log('Error getLkhEntryDetails: ' + e.toString() + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal mengambil detail entri: ' + e.message };
  }
}

function updateLkhEntry(entryId, updatedData) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    let rowIndex = -1; 
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === entryId) {
        if (data[i][1] !== userDetails.teacherId) return { status: 'error', message: 'Tidak diizinkan memperbarui entri ini.' };
        rowIndex = i;
        break;
      }
    }
    if (rowIndex === -1) return { status: 'error', message: 'Entri tidak ditemukan untuk diperbarui.' };
    
    const sheetRow = rowIndex + 1;
    const dateString = updatedData.dateOfActivity;
    const parts = dateString.split('-');
    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const day = parseInt(parts[2], 10);
    const dateOfActivity = new Date(year, month, day);
    const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    const dayName = days[dateOfActivity.getDay()];

    const oldDateStr = Utilities.formatDate(new Date(data[rowIndex][2]), Session.getScriptTimeZone(), "yyyy-MM-dd");
    const newDateStr = Utilities.formatDate(dateOfActivity, Session.getScriptTimeZone(), "yyyy-MM-dd");
    let newOrderInDay = parseInt(data[rowIndex][8]); 

    if (oldDateStr !== newDateStr) {
        newOrderInDay = getNextOrderInDay(sheet, userDetails.teacherId, dateOfActivity);
    }

    sheet.getRange(sheetRow, 3).setValue(dateOfActivity);
    sheet.getRange(sheetRow, 4).setValue(dayName);
    sheet.getRange(sheetRow, 5).setValue(updatedData.description);
    sheet.getRange(sheetRow, 6).setValue(updatedData.output);
    sheet.getRange(sheetRow, 7).setValue(updatedData.volume);
    sheet.getRange(sheetRow, 9).setValue(newOrderInDay);

    return { status: 'success', message: 'Kegiatan berhasil diperbarui.' };
  } catch (e) {
    Logger.log('Error updateLkhEntry: ' + e.toString() + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal memperbarui kegiatan: ' + e.message };
  }
}

function moveLkhEntryOrder(entryId, direction) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    let entryToMove = null;

    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === entryId) {
        if (data[i][1] !== userDetails.teacherId) return { status: 'error', message: 'Tidak diizinkan mengubah entri ini.' };
        entryToMove = {
          id: data[i][0], dateOfActivity: new Date(data[i][2]),
          order: (data[i][8] === null || data[i][8] === undefined || data[i][8] === "") ? 0 : parseInt(data[i][8]),
          sheetRow: i + 1
        };
        break;
      }
    }
    if (!entryToMove) return { status: 'error', message: 'Entri tidak ditemukan.' };

    const targetDateStr = Utilities.formatDate(entryToMove.dateOfActivity, Session.getScriptTimeZone(), "yyyy-MM-dd");
    let sameDayEntries = [];
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userDetails.teacherId) {
        const currentDate = new Date(data[i][2]);
        if (isNaN(currentDate.getTime())) continue;
        const currentDateStr = Utilities.formatDate(currentDate, Session.getScriptTimeZone(), "yyyy-MM-dd");
        if (currentDateStr === targetDateStr) {
          sameDayEntries.push({
            id: data[i][0],
            order: (data[i][8] === null || data[i][8] === undefined || data[i][8] === "") ? 0 : parseInt(data[i][8]),
            sheetRow: i + 1
          });
        }
      }
    }
    sameDayEntries.sort((a, b) => a.order - b.order);
    const currentIndexInDay = sameDayEntries.findIndex(e => e.id === entryToMove.id);
    let entryToSwapWith = null;

    if (direction === 'up') {
      if (currentIndexInDay > 0) entryToSwapWith = sameDayEntries[currentIndexInDay - 1];
      else return { status: 'info', message: 'Kegiatan sudah di urutan paling atas.' };
    } else if (direction === 'down') {
      if (currentIndexInDay < sameDayEntries.length - 1) entryToSwapWith = sameDayEntries[currentIndexInDay + 1];
      else return { status: 'info', message: 'Kegiatan sudah di urutan paling bawah.' };
    } else { return { status: 'error', message: 'Arah tidak valid.' }; }

    if (entryToSwapWith) {
      sheet.getRange(entryToMove.sheetRow, 9).setValue(entryToSwapWith.order);
      sheet.getRange(entryToSwapWith.sheetRow, 9).setValue(entryToMove.order);
      return { status: 'success', message: 'Urutan kegiatan berhasil diubah.' };
    }
    return { status: 'info', message: 'Tidak ada perubahan urutan.' };
  } catch (e) {
    Logger.log('Error moveLkhEntryOrder: ' + e.toString() + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal mengubah urutan kegiatan: ' + e.message };
  }
}

function getSchoolRowData(schoolId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const schoolSheet = ss.getSheetByName(SCHOOLS_SHEET_NAME);
  const data = schoolSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === schoolId) { 
      return {
        row: i + 1,
        sourceValueCol: 7, 
        sourceTypeCol: 8,  
        widthCol: 9,       
        heightCol: 10,     
        alignCol: 11,      
        typeKepalaMadrasahCol: 12
      };
    }
  }
  return null;
}

function isValidHttpUrl(string) {
  if (typeof string !== 'string') return false;
  const regex = /^https?:\/\/[^\s/$.?#].[^\s]*$/i;
  return regex.test(string);
}

function updateKopSuratSource(kopSuratPayload) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  if (!userDetails || !userDetails.schoolId) return { status: 'error', message: 'Data pengguna atau sekolah tidak ditemukan.' };

  const schoolId = userDetails.schoolId;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const schoolSheet = ss.getSheetByName(SCHOOLS_SHEET_NAME);
  const schoolRowData = getSchoolRowData(schoolId);

  if (!schoolRowData) return { status: 'error', message: 'Baris data sekolah tidak ditemukan.' };

  let newSourceValue = null; let newSourceType = null; let displayUrl = null; let message = "";

  try {
    const oldSchoolDetails = getSchoolDetailsForCurrentUser();
    const oldSourceValue = oldSchoolDetails ? oldSchoolDetails._rawKopSuratSourceValue : null;
    const oldSourceType = oldSchoolDetails ? oldSchoolDetails._rawKopSuratSourceType : null;

    if (kopSuratPayload.type === 'upload' || kopSuratPayload.type === 'url') {
        if (oldSourceValue && oldSourceType === 'drive') {
            try { DriveApp.getFileById(oldSourceValue).setTrashed(true); } 
            catch (e) { Logger.log("Gagal hapus file Drive lama (ID: " + oldSourceValue + "): " + e.message); }
        }
    }
    
    if (kopSuratPayload.type === 'upload' && kopSuratPayload.dataUrl) {
      const folder = DriveApp.getFolderById(KOP_SURAT_FOLDER_ID);
      const contentType = kopSuratPayload.dataUrl.substring(5, kopSuratPayload.dataUrl.indexOf(';'));
      const bytes = Utilities.base64Decode(kopSuratPayload.dataUrl.substr(kopSuratPayload.dataUrl.indexOf('base64,') + 7));
      const blob = Utilities.newBlob(bytes, contentType, kopSuratPayload.fileName);
      const driveFile = folder.createFile(blob);
      driveFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      newSourceValue = driveFile.getId(); newSourceType = 'drive'; displayUrl = driveFile.getUrl(); 
      message = "Kop surat berhasil diupload dari file.";
    } else if (kopSuratPayload.type === 'url' && kopSuratPayload.imageUrl) {
      const imageUrl = kopSuratPayload.imageUrl.trim();
      if (!isValidHttpUrl(imageUrl)) {
        return { status: 'error', message: 'Format URL gambar tidak valid.' };
      }
      newSourceValue = imageUrl; newSourceType = 'url'; displayUrl = newSourceValue;
      message = "Kop surat berhasil menggunakan URL.";
    }

    if (newSourceValue !== null && newSourceType !== null) {
      schoolSheet.getRange(schoolRowData.row, schoolRowData.sourceValueCol).setValue(newSourceValue);
      schoolSheet.getRange(schoolRowData.row, schoolRowData.sourceTypeCol).setValue(newSourceType);
    } else if (!kopSuratPayload.settings) {
       return { status: 'info', message: 'Tidak ada sumber baru atau pengaturan untuk diproses.' };
    }

    if (kopSuratPayload.settings) {
      schoolSheet.getRange(schoolRowData.row, schoolRowData.widthCol).setValue(kopSuratPayload.settings.width || "100%");
      schoolSheet.getRange(schoolRowData.row, schoolRowData.alignCol).setValue(kopSuratPayload.settings.alignment || "center");
      if (kopSuratPayload.settings.height && kopSuratPayload.settings.height.trim() !== "") {
        schoolSheet.getRange(schoolRowData.row, schoolRowData.heightCol).setValue(kopSuratPayload.settings.height);
      } else schoolSheet.getRange(schoolRowData.row, schoolRowData.heightCol).clearContent();
      message += (message && newSourceValue !== null ? " " : "") + "Pengaturan berhasil disimpan.";
    }
    return { status: 'success', message: message.trim(), sourceValue: newSourceValue, url: displayUrl, sourceType: newSourceType };
  } catch (e) {
    Logger.log("Error in updateKopSuratSource: " + e.message + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal memproses kop surat: ' + e.message };
  }
}

function deleteKopSuratImage() {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  if (!userDetails || !userDetails.schoolId) return { status: 'error', message: 'Data pengguna atau sekolah tidak ditemukan.' };
  try {
    const schoolId = userDetails.schoolId;
    const schoolSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SCHOOLS_SHEET_NAME);
    const schoolRowData = getSchoolRowData(schoolId);
    if (schoolRowData) {
      const currentSourceValueCell = schoolSheet.getRange(schoolRowData.row, schoolRowData.sourceValueCol);
      const currentSourceTypeCell = schoolSheet.getRange(schoolRowData.row, schoolRowData.sourceTypeCol);
      const currentSourceValue = currentSourceValueCell.getValue();
      const currentSourceType = currentSourceTypeCell.getValue();
      if (currentSourceValue) {
        if (currentSourceType === 'drive' && currentSourceValue) { 
          try { DriveApp.getFileById(currentSourceValue.toString()).setTrashed(true); } 
          catch (e) { Logger.log("Gagal hapus file Drive (ID: " + currentSourceValue + "): " + e.message); }
        }
        currentSourceValueCell.clearContent(); currentSourceTypeCell.clearContent();
        schoolSheet.getRange(schoolRowData.row, schoolRowData.widthCol).clearContent();
        schoolSheet.getRange(schoolRowData.row, schoolRowData.heightCol).clearContent();
        schoolSheet.getRange(schoolRowData.row, schoolRowData.alignCol).clearContent();
        schoolSheet.getRange(schoolRowData.row, schoolRowData.typeKepalaMadrasahCol).clearContent();
        return { status: 'success', message: 'Kop surat dan tipe kepala madrasah berhasil dihapus.' };
      }
      return { status: 'info', message: 'Tidak ada kop surat untuk dihapus.' };
    } else return { status: 'error', message: 'Baris data sekolah tidak ditemukan.' };
  } catch (e) {
    Logger.log("Error in deleteKopSuratImage: " + e.message + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal menghapus kop surat: ' + e.message };
  }
}

function saveKopSuratSettings(settings) {
  if (!checkUserSession()) return { status: 'error', message: 'Sesi tidak valid.' };
  const userDetails = getLoggedInUserDetails();
  if (!userDetails || !userDetails.schoolId) return { status: 'error', message: 'Data pengguna atau sekolah tidak ditemukan.' };
  try {
    const schoolId = userDetails.schoolId;
    const schoolSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SCHOOLS_SHEET_NAME);
    const schoolRowData = getSchoolRowData(schoolId);
    if (schoolRowData) {
      if (settings.width) schoolSheet.getRange(schoolRowData.row, schoolRowData.widthCol).setValue(settings.width);
      if (settings.height && settings.height.trim() !== "") schoolSheet.getRange(schoolRowData.row, schoolRowData.heightCol).setValue(settings.height);
      else schoolSheet.getRange(schoolRowData.row, schoolRowData.heightCol).clearContent();
      if (settings.alignment) schoolSheet.getRange(schoolRowData.row, schoolRowData.alignCol).setValue(settings.alignment);
      return { status: 'success', message: 'Pengaturan kop surat berhasil disimpan.' };
    } else return { status: 'error', message: 'Baris data sekolah tidak ditemukan.' };
  } catch (e) {
    Logger.log("Error in saveKopSuratSettings: " + e.message + " Stack: " + e.stack);
    return { status: 'error', message: 'Gagal menyimpan pengaturan: ' + e.message };
  }
}

function updateTeacherDetails(updatedInfo) {
  if (!checkUserSession()) {
    return { status: 'error', message: 'Sesi tidak valid. Silakan login ulang.' };
  }
  const userProperties = PropertiesService.getUserProperties();
  const teacherId = userProperties.getProperty('teacherId');
  if (!teacherId) {
    return { status: 'error', message: 'Teacher ID tidak ditemukan di sesi.' };
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const teacherSheet = ss.getSheetByName(TEACHERS_SHEET_NAME);
    const data = teacherSheet.getDataRange().getValues();
    let teacherRowIndex = -1; 
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === teacherId) { 
        teacherRowIndex = i;
        break;
      }
    }
    if (teacherRowIndex === -1) {
      return { status: 'error', message: 'Data guru tidak ditemukan di sheet.' };
    }
    const sheetRow = teacherRowIndex + 1;
    let changesMade = false;
    if (updatedInfo.hasOwnProperty('duty')) {
      teacherSheet.getRange(sheetRow, 7).setValue(updatedInfo.duty);
      changesMade = true;
    }
    if (updatedInfo.hasOwnProperty('subject')) {
      teacherSheet.getRange(sheetRow, 8).setValue(updatedInfo.subject);
      changesMade = true;
    }
    if (updatedInfo.hasOwnProperty('kelas')) {
      teacherSheet.getRange(sheetRow, 9).setValue(updatedInfo.kelas);
      changesMade = true;
    }
    if (!changesMade) {
        return { status: 'info', message: 'Tidak ada perubahan data untuk disimpan.' };
    }
    return { status: 'success', message: 'Informasi guru berhasil diperbarui.' };
  } catch (err) {
    Logger.log("Error in updateTeacherDetails: " + err.message + " Stack: " + err.stack);
    return { status: 'error', message: 'Gagal memperbarui informasi guru: ' + err.message };
  }
}

function deleteAllLkhEntriesForMonth(monthYear) {
  if (!checkUserSession()) {
    return { status: 'error', message: 'Sesi tidak valid. Silakan login ulang.' };
  }
  const userDetails = getLoggedInUserDetails();
  if (!userDetails) {
    return { status: 'error', message: 'Tidak dapat memverifikasi pengguna.' };
  }
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(LKH_ENTRIES_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    let deletedCount = 0;
    const [yearFilter, monthFilter] = monthYear.split('-').map(Number);
    for (let i = data.length - 1; i >= 1; i--) { 
      const rowData = data[i];
      const teacherIdInSheet = rowData[1];
      const dateInSheet = new Date(rowData[2]);
      if (teacherIdInSheet === userDetails.teacherId && !isNaN(dateInSheet.getTime())) {
        const entryYear = dateInSheet.getFullYear();
        const entryMonth = dateInSheet.getMonth() + 1;
        if (entryYear === yearFilter && entryMonth === monthFilter) {
          sheet.deleteRow(i + 1); 
          deletedCount++;
        }
      }
    }
    if (deletedCount > 0) {
      return { status: 'success', message: `Berhasil menghapus ${deletedCount} kegiatan dari bulan yang dipilih.` };
    } else {
      return { status: 'info', message: 'Tidak ada kegiatan yang ditemukan untuk dihapus pada bulan yang dipilih.' };
    }
  } catch (e) {
    Logger.log('Error deleting all entries for month ' + monthYear + ': ' + e.toString() + " Stack: " + e.stack);
    return { status: 'error', message: 'Terjadi kesalahan saat menghapus kegiatan: ' + e.message };
  }
}

function generatePdfReport(monthYear) {
  if (!checkUserSession()) {
    return { status: 'error', message: 'Sesi tidak valid. Silakan login ulang.' };
  }
  const user = getLoggedInUserDetails();
  const school = getSchoolDetailsForCurrentUser();
  const entries = getLkhEntriesForMonth(monthYear);

  if (!user || !school) {
    return { status: 'error', message: 'Gagal memuat data pengguna atau sekolah.' };
  }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const templateSheet = ss.getSheetByName('Template');
  if (!templateSheet) {
    return { status: 'error', message: 'Sheet "Template" tidak ditemukan di Google Sheets Anda.' };
  }
  if (PDF_REPORTS_FOLDER_ID === "GANTI_DENGAN_ID_FOLDER_PDF_ANDA") {
    return { status: 'error', message: 'Harap konfigurasikan PDF_REPORTS_FOLDER_ID di dalam skrip Code.gs terlebih dahulu.' };
  }

  const tempSheetName = `LKH_PDF_${user.fullName.replace(/\s/g, '_')}_${new Date().getTime()}`;
  const tempSheet = templateSheet.copyTo(ss).setName(tempSheetName);
  
  let lastRow = 0;

  try {
    // 1. Masukkan Kop Surat
    let imageUrlForReport = '';
    if (school && school._rawKopSuratSourceValue) {
      const sourceVal = school._rawKopSuratSourceValue;
      const sourceTyp = school._rawKopSuratSourceType || (sourceVal ? 'drive' : null);
      if (sourceTyp === 'url') {
        imageUrlForReport = sourceVal;
      } else if (sourceTyp === 'drive') {
        imageUrlForReport = `https://drive.google.com/uc?export=view&id=${sourceVal}`;
      }
    }
    if (imageUrlForReport) {
      tempSheet.getRange('B1:H1').merge();
      const cellImage = SpreadsheetApp.newCellImage().setSourceUrl(imageUrlForReport).build();
      tempSheet.getRange('B1').setValue(cellImage);
    }

    // 2. Masukkan Judul
    tempSheet.getRange('B2').setValue('LAPORAN KINERJA HARIAN (LKH)').setHorizontalAlignment('center');
    tempSheet.getRange('B3').setValue(`GURU DAN TENAGA KEPENDIDIKAN ${school.schoolName || ''}`).setHorizontalAlignment('center');
    tempSheet.getRange('B4').setValue('PEMBELAJARAN TATAP MUKA').setHorizontalAlignment('center');

    // 3. Masukkan Info Guru
    let reportPeriod = "Data tidak tersedia";
    if (entries && entries.length > 0) {
        const uniqueDates = [...new Set(entries.map(e => e.dateOfActivity))].sort();
        const workingDays = uniqueDates.length;
        const firstDate = new Date(uniqueDates[0]);
        const lastDate = new Date(uniqueDates[uniqueDates.length - 1]);
        reportPeriod = `${firstDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} - ${lastDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} (${workingDays} Hari Kerja)`;
    } else if (monthYear) {
      const [yearStrVal, monthNumVal] = monthYear.split('-');
      reportPeriod = `Bulan ${new Date(parseInt(yearStrVal), parseInt(monthNumVal)-1, 1).toLocaleDateString('id-ID', { month: 'long' })} ${yearStrVal} (0 Hari Kerja)`;
    }
    tempSheet.getRange('E6').setValue(user.fullName || '');
    tempSheet.getRange('E7').setValue(user.nip || '-');
    tempSheet.getRange('E8').setValue(user.mainDuty || '');
    tempSheet.getRange('E9').setValue(user.mataPelajaran || '-');
    tempSheet.getRange('E10').setValue(user.kelas || '-');
    tempSheet.getRange('E11').setValue(reportPeriod);

    // 4. Masukkan data kegiatan
    // ==================== PERUBAHAN UTAMA DI SINI ====================
    const processedEntries = _prepareReportData(entries);
    // =================================================================
    let currentRow = 15;
    if (processedEntries.length > 0) {
      let entryNumber = 0;
      processedEntries.forEach(pEntry => {
          if (pEntry.rowspan_nomor > 0) {
              entryNumber++;
              const range = tempSheet.getRange(currentRow, 2, pEntry.rowspan_nomor, 1);
              range.merge().setValue(entryNumber).setVerticalAlignment('middle').setHorizontalAlignment('center');
          }
          if (pEntry.rowspan_tanggal > 0) {
              const dateFormatted = `${pEntry.dayOfActivity},\n${new Date(pEntry.dateOfActivity).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`;
              const range = tempSheet.getRange(currentRow, 3, pEntry.rowspan_tanggal, 1);
              range.merge().setValue(dateFormatted).setWrap(true).setVerticalAlignment('middle').setHorizontalAlignment('center');
          }

          // Uraian Kegiatan selalu ditulis
          tempSheet.getRange(currentRow, 4, 1, 2).merge().setValue(pEntry.description).setWrap(true).setHorizontalAlignment('left').setVerticalAlignment('top');

          if (pEntry.rowspan_output > 0) {
              const range = tempSheet.getRange(currentRow, 6, pEntry.rowspan_output, 1);
              range.merge().setValue(pEntry.output).setWrap(true).setHorizontalAlignment('left').setVerticalAlignment('top');
          }
          if (pEntry.rowspan_volume > 0) {
              const range = tempSheet.getRange(currentRow, 7, pEntry.rowspan_volume, 1);
              range.merge().setValue(pEntry.volume).setWrap(true).setHorizontalAlignment('center').setVerticalAlignment('middle');
          }
          if (pEntry.rowspan_paraf > 0) {
              const range = tempSheet.getRange(currentRow, 8, pEntry.rowspan_paraf, 1);
              range.merge();
          }
          
          // Terapkan border untuk baris saat ini
          tempSheet.getRange(currentRow, 2, 1, 7).setBorder(true, true, true, true, true, true);
          currentRow++;
      });
    } else {
      tempSheet.getRange(currentRow, 2, 1, 7).merge().setValue('Tidak ada data kegiatan untuk periode ini.').setHorizontalAlignment('center');
      currentRow++;
    }
    
    lastRow = currentRow - 1;

    // 5. Masukkan Tanda Tangan
    const signatureStartRow = lastRow + 3;
    const dateForFooterSignature = (entries.length > 0) ? new Date(entries[entries.length - 1].dateOfActivity).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) : new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
    
    let locationName = 'Butung';
    if (school.schoolAddress) {
      const addressParts = school.schoolAddress.split(/[ ,]+/);
      locationName = (addressParts.length > 0) ? addressParts[0] : 'Butung';
      locationName = locationName.charAt(0).toUpperCase() + locationName.slice(1).toLowerCase();
    }
    tempSheet.getRange(signatureStartRow, 3).setValue(`Mengetahui,\n${school.typeKepalaMadrasah || 'Kepala Madrasah'}`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    const headmasterNameCell = tempSheet.getRange(signatureStartRow + 4, 3);
    headmasterNameCell.setValue(school.headmasterName || '').setFontWeight('bold').setFontLine('underline').setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    tempSheet.getRange(signatureStartRow + 5, 3).setValue(`NIP. ${school.headmasterNIP || '-'}`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    tempSheet.getRange(signatureStartRow, 7).setValue(`${locationName}, ${dateForFooterSignature}\nGuru Pengajar`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    const teacherNameCell = tempSheet.getRange(signatureStartRow + 4, 7);
    teacherNameCell.setValue((user.fullName || '').toUpperCase()).setFontWeight('bold').setFontLine('underline').setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    tempSheet.getRange(signatureStartRow + 5, 7).setValue(`NIP. ${user.nip || '-'}`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    lastRow = signatureStartRow + 5;

    // 6. Buat PDF
    SpreadsheetApp.flush();
    const pdfOptions = {
      exportFormat: 'pdf', format: 'pdf', size: 'A4', portrait: true, fitw: true,
      sheetnames: false, printtitle: false, gridlines: false, gid: tempSheet.getSheetId(),
      c1: 0, r1: 0, c2: 9, r2: lastRow 
    };
    const url = `https://docs.google.com/spreadsheets/d/${ss.getId()}/export?` + Object.entries(pdfOptions).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
    const token = ScriptApp.getOAuthToken();
    const pdfBlob = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + token } }).getBlob();
    
    const pdfFolder = DriveApp.getFolderById(PDF_REPORTS_FOLDER_ID);
    const pdfFile = pdfFolder.createFile(pdfBlob).setName(`LKH - ${user.fullName} - ${monthYear}.pdf`);
    const downloadUrl = pdfFile.getUrl().replace(/file\/d\/(.+)\/view.+/, 'uc?export=download&id=$1');
    return { status: 'success', pdfUrl: downloadUrl };
  } catch (e) {
    Logger.log("Error in generatePdfReport: " + e.message + " Stack: " + e.stack);
    return { status: 'error', message: 'Terjadi kesalahan saat membuat PDF: ' + e.message };
  } finally {
    ss.deleteSheet(tempSheet);
  }
}

function generateExcelReport(monthYear) {
  if (!checkUserSession()) {
    return { status: 'error', message: 'Sesi tidak valid. Silakan login ulang.' };
  }
  const user = getLoggedInUserDetails();
  const school = getSchoolDetailsForCurrentUser();
  const entries = getLkhEntriesForMonth(monthYear);

  if (!user || !school) {
    return { status: 'error', message: 'Gagal memuat data pengguna atau sekolah.' };
  }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const templateSheet = ss.getSheetByName('Template');
  if (!templateSheet) {
    return { status: 'error', message: 'Sheet "Template" tidak ditemukan di Google Sheets Anda.' };
  }
  if (PDF_REPORTS_FOLDER_ID === "GANTI_DENGAN_ID_FOLDER_PDF_ANDA") {
    return { status: 'error', message: 'Harap konfigurasikan PDF_REPORTS_FOLDER_ID di dalam skrip Code.gs terlebih dahulu.' };
  }

  const tempSheetName = `LKH_XLSX_${user.fullName.replace(/\s/g, '_')}_${new Date().getTime()}`;
  const tempSheet = templateSheet.copyTo(ss).setName(tempSheetName);
  
  let lastRow = 0;

  try {
    // 1. Masukkan Kop Surat
    let imageUrlForReport = '';
    if (school && school._rawKopSuratSourceValue) {
      const sourceVal = school._rawKopSuratSourceValue;
      const sourceTyp = school._rawKopSuratSourceType || (sourceVal ? 'drive' : null);
      if (sourceTyp === 'url') {
        imageUrlForReport = sourceVal;
      } else if (sourceTyp === 'drive') {
        imageUrlForReport = `https://drive.google.com/uc?export=view&id=${sourceVal}`;
      }
    }
    if (imageUrlForReport) {
      tempSheet.getRange('B1:H1').merge();
      const cellImage = SpreadsheetApp.newCellImage().setSourceUrl(imageUrlForReport).build();
      tempSheet.getRange('B1').setValue(cellImage);
    }
    
    // 2. Masukkan Judul
    tempSheet.getRange('B2').setValue('LAPORAN KINERJA HARIAN (LKH)').setHorizontalAlignment('center');
    tempSheet.getRange('B3').setValue(`GURU DAN TENAGA KEPENDIDIKAN ${school.schoolName || ''}`).setHorizontalAlignment('center');
    tempSheet.getRange('B4').setValue('PEMBELAJARAN TATAP MUKA').setHorizontalAlignment('center');
    
    // 3. Masukkan Info Guru
    let reportPeriod = "Data tidak tersedia";
     if (entries && entries.length > 0) {
        const uniqueDates = [...new Set(entries.map(e => e.dateOfActivity))].sort();
        const workingDays = uniqueDates.length;
        const firstDate = new Date(uniqueDates[0]);
        const lastDate = new Date(uniqueDates[uniqueDates.length - 1]);
        reportPeriod = `${firstDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} - ${lastDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })} (${workingDays} Hari Kerja)`;
    } else if (monthYear) {
      const [yearStrVal, monthNumVal] = monthYear.split('-');
      reportPeriod = `Bulan ${new Date(parseInt(yearStrVal), parseInt(monthNumVal)-1, 1).toLocaleDateString('id-ID', { month: 'long' })} ${yearStrVal} (0 Hari Kerja)`;
    }
    tempSheet.getRange('E6').setValue(user.fullName || '');
    tempSheet.getRange('E7').setValue(user.nip || '-');
    tempSheet.getRange('E8').setValue(user.mainDuty || '');
    tempSheet.getRange('E9').setValue(user.mataPelajaran || '-');
    tempSheet.getRange('E10').setValue(user.kelas || '-');
    tempSheet.getRange('E11').setValue(reportPeriod);

    // 4. Masukkan data kegiatan
    // ==================== PERUBAHAN UTAMA DI SINI ====================
    const processedEntries = _prepareReportData(entries);
    // =================================================================
    let currentRow = 15;
    if (processedEntries.length > 0) {
      let entryNumber = 0;
      processedEntries.forEach(pEntry => {
          if (pEntry.rowspan_nomor > 0) {
              entryNumber++;
              const range = tempSheet.getRange(currentRow, 2, pEntry.rowspan_nomor, 1);
              range.merge().setValue(entryNumber).setVerticalAlignment('middle').setHorizontalAlignment('center');
          }
          if (pEntry.rowspan_tanggal > 0) {
              const dateFormatted = `${pEntry.dayOfActivity},\n${new Date(pEntry.dateOfActivity).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}`;
              const range = tempSheet.getRange(currentRow, 3, pEntry.rowspan_tanggal, 1);
              range.merge().setValue(dateFormatted).setWrap(true).setVerticalAlignment('middle').setHorizontalAlignment('center');
          }

          tempSheet.getRange(currentRow, 4, 1, 2).merge().setValue(pEntry.description).setWrap(true).setHorizontalAlignment('left').setVerticalAlignment('top');

          if (pEntry.rowspan_output > 0) {
              const range = tempSheet.getRange(currentRow, 6, pEntry.rowspan_output, 1);
              range.merge().setValue(pEntry.output).setWrap(true).setHorizontalAlignment('left').setVerticalAlignment('top');
          }
          if (pEntry.rowspan_volume > 0) {
              const range = tempSheet.getRange(currentRow, 7, pEntry.rowspan_volume, 1);
              range.merge().setValue(pEntry.volume).setWrap(true).setHorizontalAlignment('center').setVerticalAlignment('middle');
          }
          if (pEntry.rowspan_paraf > 0) {
              const range = tempSheet.getRange(currentRow, 8, pEntry.rowspan_paraf, 1);
              range.merge();
          }
          
          tempSheet.getRange(currentRow, 2, 1, 7).setBorder(true, true, true, true, true, true);
          currentRow++;
      });
    } else {
      tempSheet.getRange(currentRow, 2, 1, 7).merge().setValue('Tidak ada data kegiatan untuk periode ini.').setHorizontalAlignment('center');
      currentRow++;
    }
    
    lastRow = currentRow - 1;

    // 5. Masukkan Tanda Tangan
    const signatureStartRow = lastRow + 3;
    const dateForFooterSignature = (entries.length > 0) ? new Date(entries[entries.length - 1].dateOfActivity).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) : new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
    let locationName = 'Butung';
    if (school.schoolAddress) {
      const addressParts = school.schoolAddress.split(/[ ,]+/);
      locationName = (addressParts.length > 0) ? addressParts[0] : 'Butung';
      locationName = locationName.charAt(0).toUpperCase() + locationName.slice(1).toLowerCase();
    }
    tempSheet.getRange(signatureStartRow, 3).setValue(`Mengetahui,\n${school.typeKepalaMadrasah || 'Kepala Madrasah'}`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    const headmasterNameCell = tempSheet.getRange(signatureStartRow + 4, 3);
    headmasterNameCell.setValue(school.headmasterName || '').setFontWeight('bold').setFontLine('underline').setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    tempSheet.getRange(signatureStartRow + 5, 3).setValue(`NIP. ${school.headmasterNIP || '-'}`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    tempSheet.getRange(signatureStartRow, 7).setValue(`${locationName}, ${dateForFooterSignature}\nGuru Pengajar`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    const teacherNameCell = tempSheet.getRange(signatureStartRow + 4, 7);
    teacherNameCell.setValue((user.fullName || '').toUpperCase()).setFontWeight('bold').setFontLine('underline').setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    tempSheet.getRange(signatureStartRow + 5, 7).setValue(`NIP. ${user.nip || '-'}`).setWrapStrategy(SpreadsheetApp.WrapStrategy.OVERFLOW).setHorizontalAlignment('left');
    lastRow = signatureStartRow + 5;

    // 6. Buat file EXCEL
    SpreadsheetApp.flush();
    const excelOptions = { format: 'xlsx', gid: tempSheet.getSheetId() };
    const url = `https://docs.google.com/spreadsheets/d/${ss.getId()}/export?` + Object.entries(excelOptions).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
    const token = ScriptApp.getOAuthToken();
    const excelBlob = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + token } }).getBlob();
    const reportFolder = DriveApp.getFolderById(PDF_REPORTS_FOLDER_ID);
    const excelFile = reportFolder.createFile(excelBlob).setName(`LKH - ${user.fullName} - ${monthYear}.xlsx`);
    const downloadUrl = excelFile.getUrl().replace(/file\/d\/(.+)\/view.+/, 'uc?export=download&id=$1');
    return { status: 'success', excelUrl: downloadUrl };
  } catch (e) {
    Logger.log("Error in generateExcelReport: " + e.message + " Stack: " + e.stack);
    return { status: 'error', message: 'Terjadi kesalahan saat membuat file Excel: ' + e.message };
  } finally {
    ss.deleteSheet(tempSheet);
  }
}
